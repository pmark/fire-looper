<!DOCTYPE html>
<html>
<head>
    <title>Loop <%= loopId %></title>
    <link href="/stylesheets/style.css" rel="stylesheet"/>
    <link href="/stylesheets/normalize.css" rel="stylesheet"/>
    <script src="/javascripts/jquery.min.js"></script>
    <!--script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script-->
</head>
<body>

<div class="loop-container">
    <div id="playhead"></div>

    <ul class="track-list">
        <% for (var i=0; i < 3; i++) {
            var t=tracks[i]; 
        %>

        <li id="track-<%= i %>">
        <% if (t) {
            for (var j=0; j < t.hits.length; j++) {
                var hit = t.hits[j]; 
        %>

            A hit has startTimeSec and duration. 
            1) set left:startTimeSec * 

                <% } %>
        <% } %>

        </li>
        <% } %>
    </ul>
</div>

<div class="menu">
<!-- <small>Loop <%= loopId %></small> -->
<a href="#" id="save-btn">Save</a>
&middot;
<a href="#" id="play-btn">Play</a>
<a href="#" id="stop-btn" style="display:none;">Stop</a>
</div>


<script>

var loop = {
    duration: 50000,  // <%= loopDuration %>
    tracks: []
}

var playhead = {
    position: 0.0,
    startTimeSec: null
};

var newHit = null;

function timestamp() {
    return (new Date().getTime() / 1000.0);
}

function advancePlayhead() {

    if (playhead.startTimeSec === null) {
        return;
    }

    var now = timestamp();
    var interval = (now - playhead.startTimeSec) * 1000.0;
    var pctComplete = (interval / loop.duration) * 100.0;
    // console.log(interval, pctComplete);

    if (interval > loop.duration) {
        // Reset playhead
        var old = playhead.startTimeSec;
        playhead.startTimeSec = timestamp();

        // console.log("new playhead start time:", 
        //     playhead.startTimeSec, 
        //     "old:", (playhead.startTimeSec-old));

        pctComplete = 0.0;
        newHit = null;
    }

    $("#playhead").css("left", pctComplete+"%");
}

function formatFloat(f) {
    return parseInt(f*100)/100;
}

///////////////////////////////////////////////////

$(function() {

    $(".track-list li").mousedown(function() {

        // Store the number of seconds from the beginning of the loop.

        var hitStartTime = 0.0;
        var now = timestamp();

        if (playhead.startTimeSec === null) {
            playhead.startTimeSec = now;
            $("#play-btn").hide();
            $("#stop-btn").show();
            // console.log("new playhead start time:", playhead.startTimeSec);
        }

        hitStartTime = formatFloat(now - playhead.startTimeSec);
        var trackNum = $(this).attr("id").split("-")[1];
        
        newHit = {
            startTimeSec:hitStartTime
        };

        // console.log("Started new hit at", now, '-', playhead.startTimeSec, '=', hitStartTime);
    });

    $(".track-list li").mouseup(function() {
        
        if (newHit) {            
            var nowMillis = timestamp();
            var playheadTimeMillis = (nowMillis - playhead.startTimeSec);

            // console.log("nowMillis:", nowMillis, "-", playhead.startTimeSec, ":playheadMillis");

            newHit.durationSec = formatFloat(playheadTimeMillis - newHit.startTimeSec);

            // console.log('Adding hit with duration', 
            //     playheadTimeMillis, '-', newHit.startTimeSec, 
            //     "= ", newHit.durationSec);

            // Add new hit to the selected track.
            var trackNum = parseInt($(this).attr("id").split("-")[1]);
            loop.tracks[trackNum] = (loop.tracks[trackNum] || []);
            loop.tracks[trackNum].push(newHit);

            newHit = {};

            console.log("Tracks:", 
                "\n0: ", JSON.stringify(loop.tracks[0]), 
                "\n1: ", JSON.stringify(loop.tracks[1]), 
                "\n2: ", JSON.stringify(loop.tracks[2]), 
                "\n");
        }

    });


    $("#save-btn").click(function() {
        alert("To do");
    });

    $("#play-btn").click(function() {
        playhead.startTimeSec = timestamp();
        $("#play-btn").hide();
        $("#stop-btn").show();
    });    

    $("#stop-btn").click(function() {
        playhead.startTimeSec = null;
        $("#stop-btn").hide();
        $("#play-btn").show();
    });

    setInterval(advancePlayhead, 10);
});

</script>
</body>
</html>
